<?php


require_once "includes/securesession.inc.php";
require_once "databasis.inc.php";
session_start();

if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $product_id = $_POST["product_id"];
    $quantity = $_POST["quantity"];
    $user_id = $_SESSION['user_id'];

    // Check if the requested quantity is available in stock
    $stmt = $sqliconn->prepare("SELECT stock FROM products WHERE id = ?");
    $stmt->bind_param("i", $product_id);
    $stmt->execute();
    $result = $stmt->get_result();
    $row = $result->fetch_assoc();
    $stock = $row['stock'];

    if ($stock >= $quantity) {
        // Check if the item is already in the cart
        $stmt = $sqliconn->prepare("SELECT * FROM cart WHERE product_id = ?");
        $stmt->bind_param("i", $product_id);
        $stmt->execute();
        $result = $stmt->get_result();
        $existingItem = $result->fetch_assoc();

        if ($existingItem) {
            // Update quantity if the item is already in the cart
            $newQuantity = $existingItem["quantity"] + $quantity;
            $stmt = $sqliconn->prepare("UPDATE cart SET quantity = ? WHERE product_id = ?");
            $stmt->bind_param("ii", $newQuantity, $product_id);
            $stmt->execute();
        } else {
            // Add the item to the cart if it's not already there
            $stmt = $sqliconn->prepare("INSERT INTO cart (product_id, quantity) VALUES (?, ?)");
            $stmt->bind_param("ii", $product_id, $quantity);
            $stmt->execute();
        }

        // Reduce the stock of the product
        $stmt = $sqliconn->prepare("UPDATE products SET stock = stock - ? WHERE id = ?");
        $stmt->bind_param("ii", $quantity, $product_id);
        $stmt->execute();
    }
}
// Redirect back to the products page
header("Location: product.php");
exit();
